<html>
<head>
    <meta charset="utf-8">
    <script src="../common/esl.js"></script>
    <script src="../common/config.js"></script>
    <link rel="stylesheet" href="../common/reset.css">
</head>
<body>
<style>
    body {
        background-color: #222;
    }
</style>
<div id="main"></div>
<button id="start-btn" class="start-btn">Start</button>
<button id="pause-btn" class="start-btn">Start</button>
<script>
    // Schema:
    var schema = [
        {name: 'Income', index: 0, text: '人均收入'},
        {name: 'LifeExpectancy', index: 1, text: '人均寿命'},
        {name: 'Country', index: 2, text: '国家'},
        {name: 'Population', index: 3, text: '总人口'}
    ];

    define('chartInstance', function (require) {
        var data = require('tools/gapminder.json');
        var echarts = require('echarts');
        require('echarts/chart/scatter');
        require('echarts/component/title');
        require('echarts/component/legend');
        require('echarts/component/tooltip');
        require('echarts/component/grid');


        var chart = echarts.init(document.getElementById('main'), null, {
            renderer: 'canvas'
        });

        var itemStyle = {
            normal: {
                opacity: 0.8,
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
        };

        var sizeFunction = function (x) {
            var x = x / 1e6;
//                y = x / 6  + 0.5;
//                y = log(x / 1e7 + 0.7) / log(1.6) + 1;
//                y = log(x + 0.4) + 1;
            var y = Math.sqrt(x) + 5;
            return y * 1.2;
        };

        var getOption = function(n) {
            if (!data.timeline[n]) {
                return;
            }
            return {
                title: {
                    show: true,
                    'text': data.timeline[n] + ' 年'
                },
                series: {
                    name: data.timeline[n],
                    type: 'scatter',
                    itemStyle: itemStyle,
                    data: data.series[n],
                    symbolSize: function(val) {
                        return sizeFunction(val[2]);
                    }
                }
            }
        };

        var option = {
            title: {
                'text': data.timeline[0] + ' 年',
                textAlign: 'center',
                x: 'center',
                textStyle: {
                    fontSize: 42,
                    color: '#fff'
                }
            },
            color: [
                '#dd4444', '#fec42c', '#80F1BE'
            ],
            tooltip: {
                padding: 5,
                backgroundColor: '#222',
                borderColor: '#777',
                borderWidth: 1,
                formatter: function (obj) {
                    var value = obj[0].value;
                    return schema[0].text + '：' + value[0] + '<br>'
                            + schema[1].text + '：' + value[1] + '<br>'
                            + schema[2].text + '：' + value[2] + '<br>'
                            + schema[3].text + '：' + value[3] + '<br>';
                }
            },
            grid: {
                x2: '10%'
            },
            xAxis: {
                type: 'value',
                name: '人均收入($)',
                max: 70000,
                nameTextStyle: {
                    color: '#fff',
                    fontSize: 18
                },
                splitLine: {
                    show: false
                },
                axisTick: {
                    lineStyle: {
                        color: '#777'
                    }
                },
                axisLabel: {
                    formatter: '{value}',
                    textStyle: {
                        color: '#fff'
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: '平均寿命(岁)',
                max: 100,
                nameTextStyle: {
                    color: '#fff',
                    fontSize: 18
                },
                axisTick: {
                    lineStyle: {
                        color: '#777'
                    }
                },
                splitLine: {
                    show: false
                },
                axisLabel: {
                    textStyle: {
                        color: '#fff'
                    }
                }
            },
            dataRange: [
                {
                    x: 'right',
                    y: 'top',
                    dimension: 'z',
                    min: 0,
                    max: 250,
                    itemWidth: 30,
                    itemHeight: 130,
                    calculable: true,
                    precision: 0.1,
                    text: ['圆形大小：PM2.5'],
                    textGap: 30,
                    textStyle: {
                        color: '#fff'
                    },
                    inRange: {
                        symbolSize: [10, 70]
                    },
                    outOfRange: {
                        symbolSize: [10, 70],
                        color: ['rgba(255,255,255,.2)']
                    },
                    controller: {
                        outOfRange: {
                            color: ['#444']
                        }
                    }
                },
                {
                    x: 'right',
                    y: 'center',
                    dimension: 'dim6',
                    min: 0,
                    max: 50,
                    itemHeight: 130,
                    calculable: true,
                    precision: 0.1,
                    text: ['明暗：二氧化硫'],
                    textGap: 30,
                    textStyle: {
                        color: '#fff'
                    },
                    inRange: {//HSL
                        colorL: [1, .5],
                        colorLightness: [1, .5]
                    },
                    outOfRange: {
                        color: ['rgba(255,255,255,.2)']
                    },
                    controller: {
                        outOfRange: {
                            color: ['#444']
                        }
                    }
                }
            ],
            series: [
                {
                    type: 'scatter',
                    itemStyle: itemStyle,
                    data: data.series[0],
                    symbolSize: function(val) {
                        return sizeFunction(val[2]);
                    }
                }
            ]
        };


        return {
            init: function() {
                chart.setOption(option);
            },
            go: function (n) {
                chart.setOption(getOption(n));
            }
        };
    });

    require(['chartInstance', 'common/tock', 'tools/gapminder.json'], function (chartInstance, Tock, data) {
        chartInstance.init();
        var i = 0;
        var timer = new Tock({
            countdown: true,
            interval: 800,
            callback: function () {
                chartInstance.go((i++));
            },
            complete: function () {
                console.log('fin');
            }
        });

        setTimeout(function () {
            timer.start(1000 * data.timeline.length);
        }, 2000);
    });
</script>
</body>
</html>